{"version":3,"file":"impactdk-barcode-scanner.js","sources":["ng://@impactdk/barcode-scanner/src/scanner/scanner.ts","ng://@impactdk/barcode-scanner/src/decoder/decoder.ts"],"sourcesContent":["import { IDecoder } from \"../decoder/decoder\";\nimport { IBarcode } from '../decoder/barcode';\n\nexport class Scanner {\n\n  private decodeCanvas: HTMLCanvasElement;\n  private constraints: MediaStreamConstraints = {\n    video: {\n      facingMode: \"environment\"\n    },\n    audio: false\n  };\n  private running = false;\n\n  constructor(private videoElement: HTMLVideoElement, private decoder: IDecoder, private cb: (barcode: IBarcode) => void) {\n    this.decodeCanvas = document.createElement(\"canvas\");\n\n    this.onLoadedData = this.onLoadedData.bind(this);\n    this.getOnFrameHandler = this.getOnFrameHandler.bind(this);\n  }\n\n  public async start(): Promise<void> {\n    this.running = true;\n    this.videoElement = this.videoElement;\n\n    this.videoElement.addEventListener(\"loadeddata\", this.onLoadedData);\n\n    // Ensure correct attributes\n    this.videoElement.setAttribute(\"autoplay\", \"\");\n    this.videoElement.setAttribute(\"muted\", \"\");\n    this.videoElement.setAttribute(\"playsinline\", \"\");\n\n    const stream = await navigator.mediaDevices.getUserMedia(this.constraints);\n\n    this.videoElement.srcObject = stream;\n\n    return new Promise<void>((res, rej) => {\n      this.resolve = res;\n      this.reject = rej;\n    });\n\n  }\n\n  public stop() {\n    if (!this.videoElement || !this.videoElement.srcObject) { return; }\n\n    this.videoElement.removeEventListener(\"loadeddata\", this.onLoadedData);\n\n    const ms = this.videoElement.srcObject as MediaStream;\n    ms.getTracks().forEach(t => t.stop());\n\n    this.videoElement.srcObject = null;\n    this.running = false;\n  }\n\n  private resolve: () => void = () => null;\n  private reject: (reason?: any) => void = () => null;\n\n  private async onLoadedData() {\n    if (!this.decodeCanvas || !this.videoElement) { this.reject(); return; }\n\n    this.decodeCanvas.height = this.videoElement.videoHeight;\n    this.decodeCanvas.width = this.videoElement.videoWidth;\n\n    requestAnimationFrame(this.getOnFrameHandler());\n  }\n\n  private getOnFrameHandler(): () => void {\n    if (!this.decodeCanvas) { return () => null; }\n\n    this.resolve();\n\n    const decodeCtx = this.decodeCanvas.getContext(\"2d\");\n\n    const onFrame = async () => {\n      if (!this.decodeCanvas || !this.videoElement) { return; }\n\n      decodeCtx.drawImage(this.videoElement, 0, 0, this.videoElement.videoWidth, this.videoElement.videoHeight);\n      let barcode: IBarcode = null;\n\n      try {\n        barcode = await this.decoder.decode(decodeCtx);\n\n        if (barcode) {\n          this.cb(barcode);\n        }\n      } catch (err) {\n        console.log({ decodeError: err.message });\n      }\n\n      if (this.running) {\n        requestAnimationFrame(onFrame);\n      }\n    };\n\n    return onFrame;\n  }\n}\n","import rawr from \"rawr\";\nimport transport from \"rawr/transports/worker\";\n\nimport { IBarcode } from './barcode';\n\nconst workerFileName = \"wasm-worker.js\";\n\nexport interface IDecoder {\n  decode(context: CanvasRenderingContext2D): IBarcode;\n}\n\nfunction sanitizeDirString(s: string): string {\n  return s.replace(/\\/$/, \"\");\n}\n\nexport class WasmDecoder implements IDecoder {\n  private static instance: WasmDecoder;\n  private wasmDecoder: any;\n  private worker: Worker;\n\n  private constructor(installationDir: string = \"\") {\n    const workerFilePath = `${installationDir}/${workerFileName}`;\n    this.worker = new Worker(workerFilePath);\n\n    this.wasmDecoder = rawr({ transport: transport(this.worker) });\n  }\n\n  public static getInstance(installationDir: string = \"\"): WasmDecoder {\n    if (!WasmDecoder.instance) {\n      const sanitized = sanitizeDirString(installationDir);\n      WasmDecoder.instance = new WasmDecoder(sanitized);\n    }\n\n    return WasmDecoder.instance;\n  }\n\n  public static removeInstance(): void {\n    WasmDecoder.instance.dispose();\n    WasmDecoder.instance = null;\n  }\n\n  public decode(context: CanvasRenderingContext2D): IBarcode {\n    const canvas = context.canvas;\n    const width = canvas.width;\n    const height = canvas.height;\n    const imageData = context.getImageData(0, 0, width, height);\n\n    return this.wasmDecoder.methods.detectUrl(width, height, imageData);\n  }\n\n  private dispose(): void {\n    this.wasmDecoder = null;\n    this.worker.terminate();\n  }\n}\n\n\n"],"names":[],"mappings":"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"}